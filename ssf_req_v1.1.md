# 스마트공방 관리 시스템 - 기능명세서 (상세/주석 강화본)
> **버전**: 1.1.0  
> **최종 수정일**: 2026-02-10  
> **배포 URL**: https://smartwork-419291531449.asia-northeast3.run.app

---

## 문서 목적 및 활용 범위

- 본 문서는 **정부주도(공공) R&D / 보급사업 / 실증사업**의 공식 산출물(기능명세서, 요구사항정의서, 설계서)의 **근거 자료**로 활용 가능하도록 작성되었다.
- “기능 요구사항(Functional Requirements)” 중심으로 작성하되, 공공 사업에서 자주 요구되는 **품질/보안/운영 관점(Non-Functional)**을 함께 명시한다.

> ※ 주석(작성 원칙)  
> - 본 문서의 “주석”은 개발/검증/감리 관점에서 **애매함을 제거**하고, 향후 변경관리 시 **판단 기준**이 되도록 의도적으로 많이 삽입했다.  
> - 실제 구현 단계에서는 주석을 토대로 **테스트케이스(정상/예외/권한/경계값)**를 자동 생성할 수 있다.

---

## 0. 용어 정의(Glossary)

| 용어 | 정의 |
|---|---|
| MES | 제조실행시스템. 생산/재고/출하/품질 등 공장 운영 데이터를 실시간 또는 준실시간으로 관리 |
| KPI | 핵심성과지표. 본 시스템에서는 생산성(PI) 및 품질(QI/Yield/불량률/폐기률)을 관리 |
| PI | Productivity Index. 계획 대비 실적 기반 생산성 지표 |
| QI | Quality Index. 불량을 제외한 실적 기준 품질 지표 |
| Yield | 수율. 불량 및 폐기를 제외한 양품 비율 |
| Snapshot | 특정 날짜 기준으로 KPI를 집계하여 저장하는 “일별 스냅샷” |

> ※ 주석  
> - 공공 산출물에는 “용어정의” 섹션이 매우 중요하다. 동일한 단어가 과제 참여기관/현장별로 다르게 쓰이면 감리 시 “요구사항 불명확” 판정을 받기 쉽다.

---

## 1. 시스템 개요

### 1.1 시스템 목적
스마트공방의 **제품, 재고, 거래처, 주문, 생산, 출하, KPI**를 통합 관리하는 웹 기반 MES(Manufacturing Execution System)

> ※ 주석(범위 명확화)  
> - 본 시스템은 “설비 제어(PLC 제어 로직)” 자체를 직접 수행하기보다는, **생산/출하/재고/품질의 업무 데이터 관리**를 주 목적으로 한다.  
> - 설비 연동이 추가되는 경우(예: 중량계, 바코드 스캐너, 비전검사기)에는 “외부 장비 → 미니PC/게이트웨이 → API” 형태의 연계를 상정한다.  
> - KPI는 “생산 완료 시점에 입력되는 실적/불량/폐기”를 기반으로 우선 제공한다. (추후 설비 실시간 데이터 연계 시 고도화 가능)

### 1.2 기술 스택
| 구분 | 기술 |
|------|------|
| 백엔드 | Node.js + Express 4.18.2 |
| 데이터베이스 | PostgreSQL (Prisma ORM) — GCP Cloud SQL |
| 프론트엔드 | Vanilla JavaScript (SPA) |
| 인증 | 세션 토큰 + SHA-256 해싱 |
| 배포 | Google Cloud Run (Docker) |

> ※ 주석(정부 과제 관점에서 자주 보는 포인트)
> - **배포**: Cloud Run은 무중단 배포/오토스케일에 유리하나, 공공기관/지자체 납품 시 “망 분리/보안/로그 보관” 요구가 있을 수 있어 운영 정책을 별도 정의한다.  
> - **DB**: PostgreSQL(GCP Cloud SQL)을 사용하며, Prisma ORM으로 DB 접근을 추상화하여 마이그레이션/스키마 관리를 자동화한다.
> - **SPA**: 단일 페이지 앱 특성상 인증 만료/401 처리 UX가 중요(자동 로그아웃 + 안내 토스트).

### 1.3 사용자 역할
| 역할 | 코드 | 권한 범위 |
|------|------|-----------|
| 전체관리자 | `super_admin` | 모든 기능 + 회원 관리 |
| 회사관리자 | `company_admin` | 일반 업무 기능 (회원 관리 제외) |

> ※ 주석(다회사 운영)  
> - `company_id` 기반 멀티테넌시를 전제로 하며, **company_admin은 자기 회사 데이터만** 접근 가능해야 한다.  
> - 공공 실증 사업에서는 다수 참여기업이 동일 시스템을 공유하는 경우가 있어 권한/데이터 분리가 감리 포인트가 된다.

---

## 2. 인증 및 회원 관리

### 2.1 로그인 (POST /api/auth/login)

**요구사항**
- 사용자는 아이디/비밀번호로 로그인한다.
- 서버는 비밀번호를 평문으로 저장하지 않고, `SHA-256(password + salt)` 방식으로 검증한다.
- 로그인 성공 시 서버 세션을 생성하고 토큰을 발급한다.
- 발급된 토큰은 클라이언트 `localStorage`에 저장한다.
- 비활성 계정은 로그인 불가.

| 항목 | 내용 |
|------|------|
| 화면 | 중앙 정렬 로그인 카드 (아이디, 비밀번호 입력 폼) |
| 요청 | `{ username, password }` |
| 응답 | `{ token, user: { id, username, name, role, company_id, company } }` |
| 세션 유효시간 | 24시간 |
| 기존 세션 | 로그인 시 기존 세션 삭제 후 새 세션 생성 |

**기본 계정(테스트용)**
| 아이디 | 비밀번호 | 역할 | 소속 |
|--------|----------|------|------|
| admin | admin1234 | 전체관리자 | 스마트공방 |
| user1 | user1234 | 회사관리자 | 스마트공방 |

> ※ 주석(보안/운영)
> - 테스트 계정은 운영 배포 시 반드시 비활성화 또는 초기화 절차가 필요하다(감리 지적 빈번).  
> - `localStorage` 저장은 편의성이 높지만 XSS에 취약할 수 있으므로, 공공 사업에서는 **CSP 적용** 및 입력값 검증을 강화한다.  
> - “salt 관리 정책(고정/개별/회전)”을 별도 문서(보안조치 계획)로 정의하면 좋다.

**예외 처리(권장)**
- 400: username/password 누락
- 401: 자격 증명 실패
- 403: 계정 비활성
- 500: 서버 오류

> ※ 주석(테스트케이스 힌트)
> - [정상] 올바른 계정 → token 발급 → /api/auth/me 성공  
> - [예외] 비활성 계정 → “비활성화된 계정입니다.”  
> - [보안] 동일 계정 동시 로그인 시 기존 세션 폐기 확인

---

### 2.2 로그아웃 (POST /api/auth/logout)
| 항목 | 내용 |
|------|------|
| 동작 | 서버 세션 삭제 + 클라이언트 토큰 삭제 |
| UI | 헤더 우측 "로그아웃" 버튼 클릭 |
| 후처리 | 로그인 화면으로 전환 |

> ※ 주석  
> - 로그아웃 시 서버 세션이 삭제되어야 “토큰 유출” 상황에서 방어가 가능하다.  
> - 프론트에서는 토큰 삭제 후 즉시 라우팅 전환 + 토스트 안내를 권장.

---

### 2.3 인증 상태 확인 (GET /api/auth/me)
| 항목 | 내용 |
|------|------|
| 동작 | 토큰으로 현재 로그인 사용자 정보 조회 |
| 앱 시작 시 | localStorage 토큰 → /api/auth/me 호출 → 유효하면 앱 표시, 만료면 로그인 화면 |
| 응답 | `{ id, username, name, role, company_id, company }` |

> ※ 주석  
> - SPA는 새로고침/재접속 시 인증 상태 확인이 필수.  
> - 만료 토큰일 경우, 프론트는 **토큰 삭제 + 로그인 화면 전환**을 자동 수행한다.

---

### 2.4 인증 미들웨어
| 항목 | 내용 |
|------|------|
| 적용 범위 | `/api/auth/*` 제외 모든 `/api/*` 요청 |
| 헤더 | `Authorization: Bearer <token>` |
| 401 처리 | 프론트엔드에서 자동으로 토큰 삭제 후 로그인 화면 전환 |

> ※ 주석(감리 관점)
> - “인증 미들웨어 적용 범위”는 반드시 명시되어야 한다.  
> - `/api/auth/*` 제외 정책은 합리적이나, “헬스체크 엔드포인트”가 추가되면 예외 목록을 따로 관리한다.

---

### 2.5 회원 관리 (super_admin 전용)

#### 2.5.1 사용자 목록 (GET /api/users)
| 항목 | 내용 |
|------|------|
| super_admin | 전체 사용자 목록 조회 |
| company_admin | 자기 회사 소속 사용자만 조회 |
| 테이블 컬럼 | 아이디, 이름, 역할(배지), 회사, 상태(활성/비활성 배지), 등록일, 관리 |
| 관리 버튼 | 상세, 수정, 삭제 (super_admin만) |
| 자기 삭제 | 불가 (삭제 버튼 미표시) |

> ※ 주석(권한)
> - company_admin이 다른 회사 사용자를 조회할 수 있으면 **치명적 결함**이다. API에서 반드시 company_id 조건을 강제한다.  
> - 테이블 목록은 개인정보(연락처/주민번호 등)를 다루지 않도록 최소화(개인정보 최소수집 원칙).

#### 2.5.2 사용자 상세 (GET /api/users/:id)
| 항목 | 내용 |
|------|------|
| 모달 표시 | 아이디, 이름, 역할, 소속 회사, 상태, 등록일 |
| 접근 제한 | company_admin은 자기 회사 소속만 조회 가능 |
| 버튼 | 닫기, 수정 (super_admin 또는 본인) |

> ※ 주석  
> - “본인 수정 가능”을 허용하는 경우, 역할/회사 변경은 제한하는 것이 일반적이다(권한 상승 방지).

#### 2.5.3 사용자 등록 (POST /api/users)
| 항목 | 내용 |
|------|------|
| 권한 | super_admin만 가능 |
| 필수 항목 | 아이디, 비밀번호(4자 이상), 이름 |
| 선택 항목 | 역할(기본: company_admin), 소속 회사, 상태(기본: 활성) |
| 유효성 검사 | 아이디 중복 체크, 비밀번호 최소 4자 |

> ※ 주석(운영 정책)
> - 비밀번호 최소 4자는 PoC 용도로는 가능하나, 운영에서는 8자 이상/복잡도 정책을 권장.  
> - 신규 사용자 등록 이벤트는 감사로그(누가/언제/무엇을)를 남기면 좋다.

#### 2.5.4 사용자 수정 (PUT /api/users/:id)
| 항목 | 내용 |
|------|------|
| super_admin | 모든 필드 수정 가능 |
| company_admin | 자기 자신만 수정 가능 (아이디, 이름, 비밀번호) |
| 비밀번호 | 비워두면 기존 비밀번호 유지 |

> ※ 주석(데이터 무결성)
> - username 변경은 다른 테이블(세션, 감사로그)에서 참조하는 경우 영향이 있으므로 운영에서는 제한을 고려할 수 있다.

#### 2.5.5 사용자 삭제 (DELETE /api/users/:id)
| 항목 | 내용 |
|------|------|
| 권한 | super_admin만 가능 |
| 제한 | 자기 자신 삭제 불가 |
| 확인 | 삭제 전 confirm 대화상자 |

> ※ 주석(삭제 정책)
> - 공공 사업에서는 “논리삭제(soft delete)”가 요구되는 경우가 많다. 본 시스템은 물리삭제를 기본으로 하나, 필요 시 `is_active=0` 방식으로 대체 가능.

#### 2.5.6 회사 목록 (GET /api/users/companies/list)
| 항목 | 내용 |
|------|------|
| 용도 | 사용자 등록/수정 시 회사 드롭다운 |
| 응답 | `[{ id, company_code, name }]` |

> ※ 주석  
> - 회사 마스터는 향후 확장(연락처/주소/사업자등록번호 등)이 가능하므로, API는 “필요 최소 필드”만 응답하도록 설계한다.

---

## 3. 대시보드

### 3.1 대시보드 화면
- 목적: 운영자가 “오늘의 상태”를 빠르게 파악(주문/생산/출하/재고 리스크)
- 접근: 모든 사용자

> ※ 주석(대시보드 구성 원칙)
> - 1) **즉시 행동이 필요한 지표(재고부족/대기주문)** 우선  
> - 2) **추세/성과 지표(KPI)**는 KPI 메뉴로 분리  
> - 3) “최근 5건”은 과도한 데이터 로딩을 막고 UX를 단순화

#### 3.1.1 요약 통계 카드 (GET /api/dashboard/summary)
| 카드 | 데이터 | 색상 조건 |
|------|--------|-----------|
| 등록 제품 | 전체 제품 수 | 기본(파란색) |
| 거래처 | 전체 거래처 수 | 기본 |
| 대기 주문 | 상태='대기' 주문 수 | > 0이면 경고(주황) |
| 진행중 생산 | 상태='대기' 또는 '진행중' 생산 수 | > 0이면 성공(초록) |
| 오늘 출하 | 출하일=오늘인 건 수 | 기본 |
| 재고 부족 | 재고 ≤ 10인 제품 수 | > 0이면 위험(빨강) |

> ※ 주석(임계치)
> - 재고 부족 기준(≤10)은 설정화 대상이 될 수 있다(현장마다 다름).  
> - “오늘 출하”는 날짜 기준(서버 타임존/로캘) 이슈가 발생할 수 있어 서버 기준을 명확히 한다.

#### 3.1.2 최근 주문 (GET /api/dashboard/recent-orders)
- 최근 5건 표시, “전체보기” 버튼 제공

> ※ 주석  
> - 정렬 기준은 `created_at DESC` 또는 `order_date DESC` 중 하나로 고정한다(업무 정의 필요).

#### 3.1.3 최근 생산 (GET /api/dashboard/recent-productions)
- 최근 5건 표시

#### 3.1.4 재고 현황 (GET /api/dashboard/inventory-status)
- 재고 적은 순 10건 표시

> ※ 주석  
> - 재고가 같은 경우 정렬 2차 기준(제품명/코드)을 두어 UI 흔들림을 줄인다.

---

## 4. 제품 관리

### 4.1 제품 목록 (GET /api/products)
| 항목 | 내용 |
|------|------|
| 메뉴 | 📦 제품 관리 |
| 헤더 버튼 | "+ 제품 등록" |
| 테이블 컬럼 | 제품코드, 제품명, 단위, 단가, 재고(≤10 빨강), 등록일, 관리 |
| 관리 버튼 | 수정, 삭제 |
| 빈 상태 | "등록된 제품이 없습니다." |

> ※ 주석(마스터 데이터)
> - 제품은 주문/생산/재고의 기준 마스터이므로, 삭제는 제한하거나 “삭제 시 영향 범위”를 명확히 해야 한다.  
> - 현재는 CASCADE로 재고/이력 삭제가 발생하므로 운영에서는 주의 문구가 필요.

### 4.2 제품 등록 (POST /api/products)
| 항목 | 내용 |
|------|------|
| 모달 제목 | "제품 등록" |
| 필수 항목 | 제품코드, 제품명 |
| 선택 항목 | 단위(기본: 개), 단가(기본: 0) |
| 유효성 검사 | 제품코드 중복 체크 |
| 부가 동작 | 재고 레코드 자동 생성 (수량 0) |

> ※ 주석(데이터 무결성)
> - 제품 등록 시 재고 레코드를 자동 생성하면, “재고 현황” 화면에서 NULL/누락 케이스가 사라져 운영 안정성이 높아진다.

### 4.3 제품 수정 (PUT /api/products/:id)
- 제품코드/제품명/단위/단가 수정 가능

> ※ 주석  
> - 제품코드 변경은 주문/생산/출하 출력물(라벨/문서)과 연결될 수 있으므로 변경이력 관리가 필요할 수 있다(고도화).

### 4.4 제품 삭제 (DELETE /api/products/:id)
| 항목 | 내용 |
|------|------|
| 확인 | "정말 삭제하시겠습니까?" |
| 연쇄 삭제 | 재고, 재고이력 함께 삭제 (CASCADE) |

> ※ 주석(공공사업 권고)
> - 운영 단계에서는 “데이터 보존 정책”상 물리삭제 대신 비활성 처리(soft delete)로 전환 권장.

---

## 5. 재고 관리

### 5.1 재고 현황 탭 (GET /api/inventory)
| 항목 | 내용 |
|------|------|
| 메뉴 | 📋 재고 관리 |
| 탭 | 재고 현황 / 입출고 이력 |
| 헤더 버튼 | "+ 입고" (초록), "- 출고/사용" (주황) |
| 테이블 컬럼 | 제품코드, 제품명, 단위, 수량(≤10 빨강), 위치, 최종 수정일 |
| 관리 버튼 | 조정, 이력 |

> ※ 주석(재고 정의)
> - “재고”는 제품 단위(개) 기준의 수량. 로트/유통기한/창고구역 등은 고도화 항목.  
> - “위치”는 자유 텍스트. 운영에서는 위치 코드 마스터를 두는 것을 고려할 수 있다.

### 5.2 입출고 이력 (GET /api/inventory/history/all)
- 최근 100건 표시

> ※ 주석(감사추적)
> - 공공 과제에서는 “재고 변동 근거”가 중요하다. `reason` 입력을 가능하면 강제(옵션→필수)로 바꾸는 것도 방법.

### 5.3 입고 (POST /api/inventory/receive)
- 입력: 제품, 수량(≥1), 사유(선택)
- 처리: 재고 증가 + 이력 기록(입고)

> ※ 주석(정합성)
> - 동시에 여러 사용자가 같은 제품을 입고할 수 있으므로, 트랜잭션 처리(또는 원자적 업데이트)가 필요하다.

### 5.4 출고/사용 (POST /api/inventory/use)
- 입력: 제품, 유형(사용/출고), 수량(≥1), 사유(선택)
- 검증: 현재고 ≥ 요청 수량
- 처리: 재고 감소 + 이력 기록(음수)

> ※ 주석(경계값)
> - 현재고 = 요청수량인 경우 정상 처리  
> - 현재고 < 요청수량인 경우 오류(사용자 안내 메시지 명확히)

### 5.5 재고 조정 (POST /api/inventory/adjust)
- 입력: 조정 수량(≥0)
- 처리: 지정 수량으로 설정 + 차이값 이력(조정)

> ※ 주석  
> - 조정은 실사/오차 보정 목적이므로, 사유 입력을 사실상 필수로 권장.

### 5.6 제품별 이력 (GET /api/inventory/:product_id/history)
- 최근 50건 표시

### 5.7 위치 수정 (PUT /api/inventory/:product_id/location)
- 위치 정보 업데이트

> ※ 주석  
> - 위치 수정은 재고 수량과 무관하나, 운영 감사 차원에서 변경 이력 테이블을 두는 고도화가 가능.

---

## 6. 거래처 관리

### 6.1 거래처 목록 (GET /api/customers)
- 코드/명/연락처/주소/등록일

> ※ 주석(개인정보)
> - 연락처는 기업 연락처 수준이며, 개인식별정보를 수집하지 않는다(원칙).  
> - 주소 역시 배송지로 활용되므로 최소 입력만 받도록 한다.

### 6.2 거래처 상세 (GET /api/customers/:id)
- 모달 + 최근 주문 10건

> ※ 주석  
> - 거래처 삭제 제한(주문 존재 시 불가)은 데이터 무결성 측면에서 타당.

### 6.3~6.5 등록/수정/삭제
- 코드 중복 체크, 주문 존재 시 삭제 불가

---

## 7. 주문 관리

### 7.1 주문 목록 (GET /api/orders)
- 상태 필터: 전체/대기/진행중/완료/취소

> ※ 주석(업무 흐름)
> - 주문 상태는 생산/출하와 연결되어 자동 변경되기도 한다(생산 시작→진행중, 전품목 출하 완료→완료).  
> - 수동 변경(PATCH)은 운영 정책에 따라 제한할 수 있다(예: 완료 상태는 변경 불가).

### 7.2 주문 상세 (GET /api/orders/:id)
- 상단 요약 + 품목 + 합계

> ※ 주석  
> - 주문 품목의 단가/금액은 매출 리포트의 근거가 되므로 변경 규칙이 명확해야 한다.

### 7.3 주문 등록 (POST /api/orders)
- 품목 1개 이상 필수
- 동일 제품 중복 시 수량 합산
- 주문번호 자동 생성(접두사+날짜+순번)

> ※ 주석(번호체계)
> - 공공 과제에서 “추적성”이 중요하므로, 주문번호 정책은 변경되더라도 과거 번호를 보존한다.

### 7.4 주문 수정 (PUT /api/orders/:id)
- 대기 상태에서만 가능

### 7.5 주문 상태 변경 (PATCH /api/orders/:id/status)
- 유효 상태: 대기/진행중/완료/취소

> ※ 주석  
> - 상태 전이는 “상태전이표(Transition Matrix)”로 별도 정의하면 감리 대응이 쉬워진다.

### 7.6 주문 삭제 (DELETE /api/orders/:id)
- 대기/취소 상태에서만 삭제

---

## 8. 생산 관리

### 8.1 생산 목록 (GET /api/productions)
- 상태 필터, 계획/실적, 불량/폐기 표시

> ※ 주석(데이터 입력 책임)
> - 생산 실적/불량/폐기는 KPI 산출의 “원천 데이터”이므로, 입력 프로세스(누가/언제/어떻게)를 현장 SOP로 함께 정의 권장.

### 8.2 생산 상세 (GET /api/productions/:id)
- 12개 항목 표시(번호/상태/제품/주문/작업자/계획/실적/불량/폐기/시작/완료)

### 8.3 생산 등록 (POST /api/productions)
- 계획수량 ≥ 1
- 연결 주문은 “진행중 주문만” 표시

> ※ 주석  
> - “대기 주문”을 연결할지 여부는 정책 결정 사항. 현재는 보수적으로 진행중만 연결.

### 8.4 생산 시작 (PATCH /api/productions/:id/start)
- 대기 → 진행중
- 시작일시 저장
- 연결 주문이 대기이면 진행중으로 자동 변경

> ※ 주석(자동 변경)
> - 자동 변경 규칙은 운영자가 인지하도록 UI에서 안내(토스트/배지 변화)하는 것이 좋다.

### 8.5 생산 완료 (PATCH /api/productions/:id/complete)
- 진행중에서만 가능
- 실적수량 필수, 불량/폐기는 기본 0
- 완료 시 재고 입고(양품수량 기준)

> ※ 주석(수량 관계식)
> - 양품수량 = actual_qty - defect_qty - waste_qty  
> - 양품수량이 음수가 되지 않도록 입력 검증 필요(예: defect+waste ≤ actual)

### 8.6 생산 중단 (PATCH /api/productions/:id/stop)
- 사유 입력(선택)
- 상태: 중단

### 8.7~8.8 수정/삭제
- 대기 상태에서만 수정, 대기/중단에서만 삭제

---

## 9. 출하 관리

### 9.1 출하 목록 (GET /api/shipments)
- 상태 필터 + 관리 버튼(상태별)

### 9.2 출하 상세 (GET /api/shipments/:id)
- 출하번호/주문번호/거래처/출하일/배송지 + 품목

### 9.3 출하 등록 (POST /api/shipments)
- 진행중 주문만 선택
- 재고 부족 시 등록 불가(사전 확인)
- 재고 차감은 “출하 완료” 시점

> ※ 주석(출하 차감 시점)
> - 등록 시 차감하면 “준비/피킹 단계”에서 재고가 과도하게 빠질 수 있다.  
> - 완료 시 차감은 현장 운영과 잘 맞지만, “출하 대기 수량(예약재고)” 개념이 필요할 수 있음(고도화).

### 9.4 출하 완료 (PATCH /api/shipments/:id/complete)
- 재고 재확인 후 차감
- 주문의 모든 품목 출하 완료 시 주문 상태도 완료로 변경

> ※ 주석(경합)
> - 여러 출하가 동시에 완료될 때 재고 경쟁 조건이 발생할 수 있으므로 서버에서 재고 재검증은 필수.

### 9.5 출하 취소 (PATCH /api/shipments/:id/cancel)
- 완료 상태는 취소 불가

### 9.6 출하 삭제 (DELETE /api/shipments/:id)
- 완료 상태는 삭제 불가

---

## 10. KPI 관리

> 사이드바 메뉴: 📊 KPI 관리 (서브메뉴 토글 그룹)  
> 하위 메뉴: 생산성, 품질

### 10.1 UI 구조(서브메뉴 토글)
- KPI 그룹 클릭 시 펼침/접기
- KPI 하위 페이지 진입 시 자동 펼침

> ※ 주석  
> - 공공 PoC에서 “메뉴 가시성/사용성”이 평가 요소인 경우가 많아, KPI를 별도 그룹으로 분리한 구조는 설명이 쉽다.

### 10.2 KPI 임계치 설정

#### 설정 조회 (GET /api/kpi/settings)
- settings 테이블의 `kpi_%` 키 조회

#### 설정 저장 (PUT /api/kpi/settings)
- `kpi_` 접두사 키만 INSERT OR REPLACE
- 5개 지표 × 3단계(목표/경고/위험)

**기본 임계치(초기값)**
| 지표 | 목표 | 경고 | 위험 | 방향 |
|------|------|------|------|------|
| 생산지수 (PI) | 95% | 85% | 70% | 높을수록 good |
| 품질지수 (QI) | 98% | 95% | 90% | 높을수록 good |
| 수율 (Yield) | 95% | 90% | 80% | 높을수록 good |
| 불량률 | 2% | 5% | 10% | 낮을수록 good (inverted) |
| 폐기률 | 3% | 5% | 10% | 낮을수록 good (inverted) |

> ※ 주석(현장 튜닝)
> - 임계치는 업종/공정/제품군에 따라 크게 다르므로 “초기값”임을 명시한다.  
> - 운영 시에는 “제품별 임계치”가 필요할 수 있으나, v1.1에서는 공통 임계치를 우선 제공한다.

**상태 색상 로직**
| 상태 | 일반 지표(높을수록 좋음) | inverted 지표(낮을수록 좋음) |
|---|---|---|
| good | value ≥ target | value ≤ target |
| warning | value ≥ warning | value ≤ warning |
| danger | value < warning | value > warning |

> ※ 주석  
> - inverted 지표는 프로그레스바 표현이 직관적이지 않을 수 있어 “최대 10%를 100%로 스케일”하는 UI 정책을 적용(명세에 반영됨).

---

### 10.3 생산성 KPI (GET /api/kpi/productivity)

**입력 파라미터(선택)**
- `start_date`, `end_date`, `product_id`

**데이터 소스**
- productions 테이블
- 조건: `status='완료' AND completed_at IS NOT NULL`

**산식**
- `PI = (SUM(actual_qty) / SUM(planned_qty)) × 100`

> ※ 주석(산식 선택 이유)
> - “일별 평균(개별 PI의 평균)”과 “합산 기반 비율”은 값이 달라질 수 있다.  
> - v1.1은 **합산 기반 비율**을 채택하여 생산 규모가 큰 데이터가 자연스럽게 더 큰 가중치를 갖는다.

**필터바**
- 기본: 최근 30일
- 제품 드롭다운: 전체/개별
- 스냅샷 생성 버튼 제공

**요약 카드(3)**
- PI(%), 총 실적(하위: 계획), 완료 건수

**테이블(2)**
- 일별 집계
- 제품별 집계

> ※ 주석(데이터 없음)
> - 조회 기간에 완료 생산이 0건이면, PI는 “N/A”로 표시하고 안내 메시지를 출력하는 것을 권장(0으로 표시하면 오해 가능).

---

### 10.4 품질 KPI (GET /api/kpi/quality)

**산식**
- `QI = (actual - defect) / actual × 100`
- `Yield = (actual - defect - waste) / actual × 100`
- `Defect Rate = defect / actual × 100`
- `Waste Rate = waste / actual × 100`

> ※ 주석(0 나누기 방지)
> - actual=0인 경우(비정상 데이터) 지표 계산이 불가하므로 서버에서 0 처리/제외 규칙을 명시해야 한다.  
> - 권장: actual=0 레코드는 집계에서 제외 + 로그로 남김(데이터 품질 관리).

**요약 카드(4)**
- QI, Yield, 불량률, 폐기률(각각 임계치 색상)

**테이블**
- 일별, 제품별

---

### 10.5 KPI 스냅샷

#### 스냅샷 생성 (POST /api/kpi/snapshot)
- 요청: `{ date }` (기본: 오늘)
- 처리: 해당 날짜 완료 생산 → 제품별 집계 → `kpi_daily INSERT OR REPLACE`
- 응답: `{ message, count }`

> ※ 주석(스냅샷 의의)
> - 스냅샷은 “조회 성능 최적화” + “성과보고용(월간/주간) 고정 값” 확보에 유리하다.  
> - 공공 사업에서 “성과지표 증빙” 제출 시 날짜별 고정 데이터가 필요할 때 유용.

#### 스냅샷 이력 조회 (GET /api/kpi/snapshots)
- 날짜 DESC, 제품명 ASC 정렬

---

## 11. 리포트

> ※ 주석(리포트 vs KPI)
> - 리포트는 “집계 데이터(현황/실적)” 중심  
> - KPI는 “평가/진단 지표(임계치, 색상, 경고)” 중심  
> - 둘을 분리하면 기능 설명과 사용자 교육이 쉬워진다.

### 11.1 리포트 탭
- 생산/출하/매출/재고 현황

### 11.2~11.5
- 각 리포트는 “기본 30일” 같은 제한을 두어 성능과 UX를 확보

---

## 12. 설정

### 12.1 설정 화면
- 회사명, 접두사 등 시스템 파라미터 관리

> ※ 주석  
> - 접두사 변경은 번호체계에 영향을 주므로 “변경 시점 이후 생성분에만 적용”되는 규칙을 권장.

---

## 13. 데이터베이스 스키마(요약)

> ※ 주석(정합성)
> - 본 시스템의 핵심 데이터는 `products / orders / productions / shipments / inventory`로 구성되며, KPI는 productions 기반 파생 데이터로 관리한다.

### 13.1 테이블(15)
- products, inventory, inventory_history, customers, orders, order_items, productions, shipments, shipment_items, settings, companies, users, sessions, kpi_daily

### 13.2 kpi_daily(핵심)
- UNIQUE(date, company_id, product_id)
- KPI/수량/건수 저장

> ※ 주석(멀티테넌시)
> - kpi_daily는 company_id를 포함하여 회사별 KPI를 분리한다(감리 포인트).

---

## 14. 업무 프로세스(흐름)

### 14.1 주문 → 생산 → 출하
1) 주문 등록(대기)  
2) 생산 등록(주문 연결)  
3) 생산 시작 → 주문 진행중 자동 전환  
4) 생산 완료 → 양품 재고 입고  
5) 출하 등록(주문 연결)  
6) 출하 완료 → 재고 차감 → 전품목 출하 시 주문 완료  

> ※ 주석(정책)
> - “전품목 출하”의 판단 기준은 주문 품목 대비 출하 누적 수량이다. 부분 출하가 허용되면 누적 비교 로직이 필요하다.

### 14.2 재고 변동 경로
- 수동 입고/출고/사용/조정
- 생산 완료(입고)
- 출하 완료(출고)

---

## 15. API 엔드포인트(운영/감리용 추가 가이드)

> ※ 주석(권장 공통 규칙)
> - 모든 API 응답은 `{ success, data, message }` 형태로 표준화하면 유지보수/테스트가 쉬워진다(현재 명세는 핵심 데이터만 기술).  
> - 오류 응답은 `{ error_code, message, details }` 형태를 권장.  
> - 로그/감사 대응을 위해 “주요 변경 API(등록/수정/삭제)”는 서버 로그에 `user_id, company_id, entity_id`를 남긴다.

(기존 55개 엔드포인트 목록은 v1.1 원문과 동일)

---

## 16. UI/UX 공통 사항(상세)

### 16.1 레이아웃
- 사이드바(240px), 헤더, 컨텐츠 영역, 모바일 대응(≤768px)

> ※ 주석  
> - 공공 PoC 시 “모바일 대응 여부”가 요구될 수 있어 최소 대응(햄버거 메뉴) 포함은 장점.

### 16.2 공통 컴포넌트
- 모달/토스트/배지/로딩/빈 상태

> ※ 주석(접근성)
> - 공공기관 납품 시 접근성(키보드 조작/포커스/ARIA) 요구가 발생할 수 있다. 모달의 ESC 닫기/포커스 트랩은 기본 권장.

### 16.3 색상 체계
- 기본/성공/위험/경고/텍스트/배경

### 16.4 숫자/날짜 포맷
- ko-KR 포맷 적용

> ※ 주석  
> - 서버/DB 시간대(UTC vs KST)가 다르면 “오늘” 기준이 어긋날 수 있다. 운영 정책에서 시간대 기준을 명확히 한다.

---

## 부록 A. 비기능 요구사항(공공 사업 대응용 권장)

### A.1 보안
- 비밀번호 평문 저장 금지, 해시+salt 적용
- 인증 토큰 만료(24h) 및 세션 삭제
- 권한 체크(역할+company_id) 서버에서 강제
- 입력값 검증(서버/클라이언트) 및 XSS 방지

### A.2 감사로그/이력
- 중요 이벤트(로그인/로그아웃/등록/수정/삭제/출하완료/생산완료/KPI설정변경)에 대해 로그 기록
- 필요 시 `audit_log` 테이블 추가(고도화)

### A.3 성능/가용성
- 대시보드/리포트는 기본 기간 제한(예: 30일)
- 스냅샷으로 KPI 조회 성능 확보
- Cloud Run 오토스케일 활용(최소 인스턴스 정책은 운영에 맞게)

### A.4 데이터 품질
- 생산 완료 시 수량 관계식 검증(defect+waste ≤ actual)
- actual=0 데이터는 KPI 계산에서 제외 또는 0 처리 규칙 명시

> ※ 주석  
> - 부록은 공공 과제 문서(보안조치/안전조치/운영계획)로 확장될 때 바로 복붙 가능한 형태로 구성했다.

---

**총 API 엔드포인트: 55개** | **총 DB 테이블: 15개** | **총 페이지: 12개**
